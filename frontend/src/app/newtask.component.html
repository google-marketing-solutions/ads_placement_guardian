<div class="centre-form">
    <form [formGroup]="gadsForm">
        <div class="heading">
            <span *ngIf='task_id!=undefined && this.task_id!=""'>Task ID / {{task_id}} <div class="label-input-block">
                <a (click)="duplicateTask()" matTooltip="Make a copy">
                    <mat-icon>file_copy</mat-icon>
                </a>
            </div></span>
            <span *ngIf='task_id==undefined || this.task_id==""'>New Task</span>
        </div>
        <div class="centre-form">
            <div class="label-input-block top-centre-form">
                <label for="taskName">Task Name</label><br>
                <input type="text" [className]="task_name_error ? 'errorElement' : 'inputElement'" formControlName="taskName" name="taskName"><br>
                <span class="error_text" *ngIf=task_name_error>Must have a name to save</span>
            </div>
            <div class="label-input-block top-centre-form">
                <label for="gadsCustomerId">Customer ID <a (click)="switch_cid()" class="smalltext">{{cid_choice}}</a><br>
                <select [className]="customer_id_error ? 'errorElement' : 'inputElement'" *ngIf="!manual_cid" name="gadsCustomerId" class="inputElement" formControlName="gadsCustomerId" id="gadsCustomerId">
                    <option *ngFor="let cust_list of customer_list" [value]=cust_list.id>{{ cust_list.account_name }} [{{ cust_list.id }}]</option>
                </select>
                <input *ngIf="manual_cid" type="text" [className]="customer_id_error ? 'errorElement' : 'inputElement'" formControlName="gadsCustomerId" name="gadsCustomerId"><br>
                <span class="error_text" *ngIf=customer_id_error>Needs a valid CID</span></label>
            </div>
            <div class="label-input-block top-centre-form">
                <label for="fromDaysAgo">From Days Ago</label><br>
                <input type="text" [className]="from_lookback_error ? 'smallErrorElement' : 'smallInputElement'" formControlName="fromDaysAgo" name="fromDaysAgo"><br>
                <span class="error_text" *ngIf=from_lookback_error>Must be number <= 90</span>
            </div>
            <div class="label-input-block top-centre-form">
                <label for="lookbackDays">Lookback Days</label><br>
                <input type="text" [className]="lookback_error ? 'smallErrorElement' : 'smallInputElement'" formControlName="lookbackDays" name="lookbackDays"><br>
                <span class="error_text" *ngIf=lookback_error>Must be number <= 90</span>
            </div>
            <div class="label-input-block top-centre-form">
                <label for="schedule">Schedule</label><br>
                <select name="schedule" class="inputElement" formControlName="schedule" id="schedule" (change)="scheduleChange()">
                    <option *ngFor="let item of scheduleArray" [value]=item[0]>{{ item[1] }}</option>
                </select>
            </div>
        </div>
        <!-- Google Filters -->
        <div class="filterBorder">
            <b>Google Ads Filters</b> (per placemnet & ad-group)<br><br>
            <div [className]="gads_data_error ? 'label-input-block largeErrorElement' : 'label-input-block'">
                YouTube <mat-slide-toggle name="gadsDataYouTube" [(ngModel)]="gads_data_youtube" formControlName="gadsDataYouTube" id="gadsDataYouTube">
                </mat-slide-toggle> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                Display <mat-slide-toggle name="gadsDataDisplay" [(ngModel)]="gads_data_display" formControlName="gadsDataDisplay" id="gadsDataDisplay">
                </mat-slide-toggle> 
                <span class="error_text" *ngIf=gads_data_error>You must select at least one data type to retrieve</span>
            </div><br><br>
            <div class="label-input-block ">
                <label for="gadsField">Metric</label><br>
                <select name="gadsField" formControlName="gadsField" class="inputElement" id="gadsField">
                    <option *ngFor="let item of gadsFieldsArray" [value]=item[0]>{{ item[1] }}</option>
                </select>
            </div>
            <div class="label-input-block">
                <label for="gadsOperator">Operator</label><br>
                <select name="gadsOperator" formControlName="gadsOperator" class="inputElement" id="gadsOperator">
                    <option *ngFor="let item of gadsOperatorsArray" [value]=item[0]>{{ item[1] }}</option>
                </select>
            </div>
            <div class="label-input-block">
                <label for="gadsValue">Value <span class="error_text" *ngIf=gads_error>{{gads_error_msg}}</span></label><br>
                <input type="text" [className]="gads_error ? 'errorElement' : 'inputElement'"
                    formControlName="gadsValue" name="gadsValue">
            </div>
            <div class="label-input-block">
                <button type="button" id="gadsAddToFilters" class="focusButton" (click)="gadsAddFilter()"
                    [disabled]=!conditionEnabled>+ Add</button>
            </div>
            <div class="label-input-block">
                <button type="button" id="gadsAddAnd" class="focusButton" (click)="gadsAddOrAnd('AND')"
                    [disabled]=!orAndEnabled>AND</button>
            </div>
            <div class="label-input-block">
                <button type="button" id="gadsAddOr" class="focusButton" (click)="gadsAddOrAnd('OR')"
                    [disabled]=!orAndEnabled>OR</button>
            </div>
            <div>
                <div class="label-input-block">
                    &nbsp; &nbsp; &nbsp;<mat-icon class="bigicon">subdirectory_arrow_right</mat-icon>
                    &nbsp;<input [className]="gads_filter_error ? 'errorElement extrawide' : 'inputElement extrawide'"
                        type="text" [(ngModel)]=finalGadsFilter formControlName="gadsFinalFilters" name="gadsFinalFilters"
                        value="{{finalGadsFilter}}" [readonly]=gads_filter_lock>
                    <br><span class="error_text" *ngIf=gads_filter_error>Errors in format. Do not end with OR or AND</span>
                </div>
                <div class="label-input-block">
                    <button type="button" id="unlockFilter" class="bigicon" (click)="unlockFilter()" matTooltip="Unlock/lock filter for free text">
                        <mat-icon class="red_icon" *ngIf="gads_filter_lock">lock</mat-icon> 
                        <mat-icon class="green_icon" *ngIf="!gads_filter_lock">lock_open</mat-icon>
                    </button>
                    <button type="button" id="clearGadsFilter" class="deleteButton" (click)="clearFilter()" matTooltip="Clear current GAds filters">
                        <mat-icon>delete_forever</mat-icon>
                    </button>
                </div>
            </div>
        </div>
        <br>
        <!-- YouTube Filters-->
        <div class="filterBorder">
            <div class="label-input-block">
            <b>YouTube Exclusion Rules (AND only)</b>
            </div>
                <div class="label-input-block align-right">
                    Include YouTube Data <mat-slide-toggle name="includeYouTube" [(ngModel)]="include_youtube" formControlName="includeYouTube" id="includeYouTube">
                    </mat-slide-toggle> 
                </div>
            <br>
            <br>
            <div>
                <div class="label-input-block yt-label">
                    Subscriber Count
                </div>
                <div class="label-input-block">
                    <label for="ytSubscriberOperator">Operator</label><br>
                    <select name="ytSubscriberOperator" formControlName="ytSubscriberOperator" class="inputElement"
                        id="ytSubscriberOperator">
                        <option *ngFor="let item of ytMetricOperatorsArray" [value]=item[0]>{{ item[1] }}</option>
                    </select>
                </div>
                <div class="label-input-block">
                    <label for="ytSubscriberValue">Value</label><br>
                    <input type="text" [className]="yt_subscribers_error ? 'errorElement' : 'inputElement'"
                        formControlName="ytSubscriberValue" name="ytSubscriberValue">
                    <span class="error_text" *ngIf=yt_subscribers_error>Needs to be a number</span>
                </div>
            </div>
            <div>
                <div class="label-input-block yt-label">
                    View Count
                </div>
                <div class="label-input-block">
                    <select name="ytViewOperator" formControlName="ytViewOperator" class="inputElement"
                        id="ytViewOperator">
                        <option *ngFor="let item of ytMetricOperatorsArray" [value]=item[0]>{{ item[1] }}</option>
                    </select>
                </div>
                <div class="label-input-block">
                    <input type="text" [className]="yt_view_error ? 'errorElement' : 'inputElement'"
                        formControlName="ytViewValue" name="ytViewValue">
                    <span class="error_text" *ngIf=yt_view_error>Needs to be a number</span>
                </div>
            </div>
            <div>
                <div class="label-input-block yt-label">
                    Video Count
                </div>
                <div class="label-input-block">
                    <select name="ytVideoOperator" formControlName="ytVideoOperator" class="inputElement"
                        id="ytVideoOperator">
                        <option *ngFor="let item of ytMetricOperatorsArray" [value]=item[0]>{{ item[1] }}</option>
                    </select>
                </div>
                <div class="label-input-block">
                    <input type="text" [className]="yt_video_error ? 'errorElement' : 'inputElement'"
                        formControlName="ytVideoValue" name="ytVideoValue">
                    <span class="error_text" *ngIf=yt_video_error>Needs to be a number</span>
                </div>
            </div>
            <div>
                <div class="label-input-block yt-label">
                    Language
                </div>
                <div class="label-input-block">
                    <select name="ytLanguageOperator" formControlName="ytLanguageOperator" class="inputElement"
                        id="ytLanguageOperator">
                        <option *ngFor="let item of ytTextOperatorsArray" [value]=item[0]>{{ item[1] }}</option>
                    </select>
                </div>
                <div class="label-input-block">
                    <input type="text" [className]="yt_language_error ? 'errorElement' : 'inputElement'"
                        formControlName="ytLanguageValue" name="ytLanguageValue">
                    <span class="error_text" *ngIf=yt_language_error>Needs to be a language code (eg. en)</span>
                </div>
            </div>
            <div>
                <div class="label-input-block yt-label">
                    Country
                </div>
                <div class="label-input-block">
                    <select name="ytCountryOperator" formControlName="ytCountryOperator" class="inputElement"
                        id="ytCountryOperator">
                        <option *ngFor="let item of ytTextOperatorsArray" [value]=item[0]>{{ item[1] }}</option>
                    </select>
                </div>
                <div class="label-input-block">
                    <input type="text" [className]="yt_country_error ? 'errorElement' : 'inputElement'"
                        formControlName="ytCountryValue" name="ytCountryValue">
                    <span class="error_text" *ngIf=yt_country_error>Needs to be a country code (eg.
                        UK)</span>
                </div>
            </div>
            <div>
                <div class="label-input-block yt-label">
                    Standard Title Characters
                </div>
                <div class="label-input-block">
                    <select name="ytStandardCharValue" formControlName="ytStandardCharValue" class="inputElement"
                        id="ytStandardCharValue">
                        <option *ngFor="let item of ytYesNoOperatorsArray" [value]=item[0]>{{ item[1] }}</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- Form End -->
        <br>
        <div class="label-input-block formSubmits">
            <div class="float-left">
            <div class="label-input-block">
                <button type="button" class="secondaryButton" (click)="run_auto_excluder_form(false)"
                    value="Preview">Preview Results</button>
            </div>
            <div class="label-input-block">
                <button type="button" [className]="exclude_count == 0 ? 'disabledButton' : 'secondaryButton'"
                    (click)="run_manual_excluder_form()" value="Preview">Manually Exclude ({{ exclude_count }})</button>
            </div>
        </div>
            <div class="label-input-block" [hidden]="email_alerts_hidden">
                Email Alerts <mat-slide-toggle name="emailAlerts" [(ngModel)]="email_alerts" formControlName="emailAlerts" id="emailAlerts">
                </mat-slide-toggle> 
            </div>
            <div class="label-input-block">
                <button type="button" class="saveButton" (click)="save_task()">{{save_button}}</button>
            </div>
        </div>
    </form>
</div>
<p>
<!---->
<div *ngIf="table_result.length > 0" >
    <div class="pagination-left">
        <span class="error_text" *ngIf=memory_error><mat-icon>warning</mat-icon> Your report is only partial due to memory of your instance being reached</span> 
        </div>
    <div class="pagination">
    <form [formGroup]="paginationForm">
        <div class="label-input-block">	<a (click)="downloadCSV()"><mat-icon>save_alt</mat-icon> Download CSV</a></div>
        <div class="label-input-block">
            <span *ngIf="pagination_start+pagination_rpp <= table_result.length">
                {{pagination_start+1}} to {{pagination_start+pagination_rpp}} of {{table_result.length}}
            </span>
            <span *ngIf="pagination_start+pagination_rpp > table_result.length  && table_result.length > 0">
                {{pagination_start+1}} to {{table_result.length}} of {{table_result.length}}
            </span>
        </div>
        <div class="label-input-block">
            <button type="button" class="pageButton" (click)="pagination_prev()"><<</button>
        </div>
        <div class="label-input-block">
            <select name="paginationValue" formControlName="paginationValue" (change)="paginationChange()"
                class="pageElement" id="paginationValue">
                <option *ngFor="let item of pagination_values" [value]=item[0]>{{ item[0] }}</option>
            </select>
        </div>
        <div class="label-input-block">
            <button type="button" class="pageButton" (click)="pagination_next()">>></button>
        </div>
    </form>
</div>
</div>
<span *ngIf="table_result.length > 0">
From:{{this.date_from}} &nbsp;&nbsp;&nbsp;To:{{this.date_to}}
</span>
<table *ngIf="table_result.length > 0" class="styled-table newtask-width">
    <thead>
        <tr>
            <th class="hrlink"><a (click)="sort_table('default')">Exclude</a></th>
            <th class="hrlink"><a (click)="sort_table('excluded_already')">Status</a></th>
            <th class="hrlink"><a (click)="sort_table('allowlist')">Allowlist</a></th>
            <th class="hrlink"><a (click)="sort_table('group_placement_view_placement_type')">Type</a></th>
            <th class="hrlink"><a (click)="sort_table('group_placement_view_display_name')">Placement Name</a></th>
            <th class="hrlink"><a (click)="sort_table('group_placement_view_placement')">Channel/URL</a></th>
            <th class="hrlink"><a (click)="sort_table('ad_group_name')"></a>Ad Group Name</th>
            <th class="hrlink"><a (click)="sort_table('campaign_name')"></a>Campaign Name</th>
            <th class="hrlink"><a (click)="sort_table('metrics_impressions')">Impressions</a></th>
            <th class="hrlink"><a (click)="sort_table('metrics_clicks')">Clicks</a></th>
            <th class="hrlink"><a (click)="sort_table('metrics_video_views')">Video Views</a></th>
            <th class="hrlink"><a (click)="sort_table('metrics_cost')">Cost</a></th>
            <th class="hrlink"><a (click)="sort_table('metrics_conversions')">Conversions</a></th>
            <th class="hrlink"><a (click)="sort_table('metrics_cost_per_conversion')">CPA</a></th>
            <th class="hrlink"><a (click)="sort_table('metrics_view_through_conversions')">View-Through Conversions</a></th>
            <th class="hrlink"><a (click)="sort_table('metrics_average_cpm')">Avg. CPM</a></th>
            <th class="hrlink"><a (click)="sort_table('metrics_ctr')">CTR</a></th>
            <th class="hrlink"><a (click)="sort_table('subscriberCount')">YouTube Subscribers</a></th>
            <th class="hrlink"><a (click)="sort_table('viewCount')">YouTube View Count</a></th>
            <th class="hrlink"><a (click)="sort_table('videoCount')">YouTube Video Count</a></th>
            <th class="hrlink"><a (click)="sort_table('language')">YouTube Language</a></th>
            <th class="hrlink"><a (click)="sort_table('country')">YouTube Country</a></th>
            <th class="hrlink"><a (click)="sort_table('asciiTitle')">YouTube Title Standard Characters</a></th>
        </tr>
    </thead>
    <tbody>
        <tr *ngFor="let data of table_result | slice:pagination_start:pagination_start+pagination_rpp"
        [className]="row_class(data.excluded_already, data.exclude_from_account, data.allowlist)">
            <td><input [value]="data.group_placement_view_placement" type="checkbox"
                    (change)="excludeCheckChange(data.group_placement_view_placement)"
                    [checked]="data.exclude_from_account && !data.excluded_already && !data.allowlist" 
                    [disabled]="row_disabled(data.excluded_already, data.allowlist)"/></td>
            <td *ngIf="data.excluded_already"><mat-icon matTooltip="Excluded">block</mat-icon></td>
            <td *ngIf="!data.excluded_already"><mat-icon matTooltip="Active" class="green_icon">check_circle</mat-icon></td>       
            <td><span *ngIf="!data.allowlist"><a class="grey_icon" (click)="addToAllowlist(data.group_placement_view_placement_type, data.group_placement_view_placement)" 
                target="_self" matTooltip="Add placement to allowlist so it is never excluded"><mat-icon>add_circle_outline</mat-icon></a></span>
                
                <span *ngIf="data.allowlist"><a (click)="removeFromAllowlist(data.group_placement_view_placement)" 
                    target="_self" matTooltip="Remove placement from allowlist so it can be excluded"><mat-icon class="gold_icon">stars</mat-icon></a></span>
                </td>
            <td *ngIf="data.group_placement_view_placement_type==2"><mat-icon matTooltip="Display">picture_in_picture</mat-icon></td>
            <td *ngIf="data.group_placement_view_placement_type==6"><mat-icon matTooltip="YouTube">video_library</mat-icon></td>
            <td>{{data.group_placement_view_display_name}}</td>
            <td><a href="https://{{data.group_placement_view_target_url}}" target="_blank">{{
                    data.group_placement_view_placement }}</a></td>
            <td>{{data.ad_group_name}}</td>   
            <td>{{data.campaign_name}}</td>       
            <td>{{data.metrics_impressions | number}}</td>
            <td>{{data.metrics_clicks | number}}</td>
            <td>{{data.metrics_video_views | number}}</td>
            <td>{{data.metrics_cost | number : '1.2-2'}}</td>
            <td>{{data.metrics_conversions | number}}</td>
            <td>{{data.metrics_cost_per_conversion | number : '1.2-2'}}</td>
            <td>{{data.metrics_view_through_conversions | number}}</td>
            <td>{{data.metrics_average_cpm | number : '1.2-2'}}</td>
            <td>{{(data.metrics_ctr * 100) | number : '1.2-2'}}%</td>
            <td>{{data.subscriberCount | number}}</td>
            <td>{{data.viewCount | number}}</td>
            <td>{{data.videoCount | number}}</td>
            <td>{{data.language}}</td>
            <td>{{data.country}}</td>
            <td>{{data.asciiTitle}}</td>
        </tr>
    </tbody>
</table>
<div *ngIf="no_data" class="empty-table">No data matches your Google Ads filters!</div>
<app-loading [showSpinner]=loading></app-loading>