<div class="centre-form">
    <form [formGroup]="gadsForm">
        <div class="heading">
            <span *ngIf='task_id!=undefined && this.task_id!=""'>Task ID / {{task_id}} <div class="label-input-block">
                <a (click)="duplicateTask()" matTooltip="Make a copy">
                    <mat-icon>file_copy</mat-icon>
                </a>
            </div></span>
            <span *ngIf='task_id==undefined || this.task_id==""'>New Task</span>
        </div>

            <div class="align-left">
                <label for="taskName">Task Name</label><br>
                <input type="text" [className]="task_name_error ? 'errorElement extrawide' : 'inputElement extrawide'" formControlName="taskName" name="taskName"><br>
                <span class="error_text" *ngIf=task_name_error>Must have a name to save</span>
            </div>
        <div class="label-input-block">
            <br>
        </div>
        <div>
            <div class="label-input-block top-centre-form">
                <label for="gadsCustomerId">Customer ID <a (click)="switch_cid()" class="smalltext">{{cid_choice}}</a><br>
                <select [className]="customer_id_error ? 'errorElement' : 'inputElement'" *ngIf="!manual_cid" name="gadsCustomerId" class="inputElement" formControlName="gadsCustomerId" id="gadsCustomerId">
                    <option *ngFor="let cust_list of customer_list" [value]=cust_list.id>{{ cust_list.account_name }} [{{ cust_list.id }}]</option>
                </select>
                <input *ngIf="manual_cid" type="text" [className]="customer_id_error ? 'errorElement' : 'inputElement'" formControlName="gadsCustomerId" name="gadsCustomerId"><br>
                <span class="error_text" *ngIf=customer_id_error>Needs a valid CID</span></label>
            </div>
            <div class="label-input-block top-centre-form">
                <label for="fromDaysAgo">From Days Ago</label><br>
                <input type="text" [className]="from_lookback_error ? 'smallErrorElement' : 'smallInputElement'" formControlName="fromDaysAgo" name="fromDaysAgo"><br>
                <span class="error_text" *ngIf=from_lookback_error>Must be number <= 90</span>
            </div>
            <div class="label-input-block top-centre-form">
                <label for="lookbackDays">Lookback Days</label><br>
                <input type="text" [className]="lookback_error ? 'smallErrorElement' : 'smallInputElement'" formControlName="lookbackDays" name="lookbackDays"><br>
                <span class="error_text" *ngIf=lookback_error>Must be number <= 90</span>
            </div>
            <div class="label-input-block top-centre-form">
                <label for="exclusionLevel">Exclusion Level</label><br>
                <select name="exclusionLevel" class="smallInputElement" formControlName="exclusionLevel" id="exclusionLevel" [(ngModel)]="selectedExclusionLevel">
                    <option *ngFor="let item of exclusionLevelArray" [value]="item[0]" [selected]="item[0] === defaultExclusionLevel">{{ item[1] }}</option>
                  </select>
            </div>
            <div class="label-input-block top-centre-form">
                <label for="schedule">Schedule</label><br>
                <select name="schedule" class="inputElement" formControlName="schedule" id="schedule" (change)="scheduleChange()">
                    <option *ngFor="let item of scheduleArray" [value]=item[0]>{{ item[1] }}</option>
                </select>
            </div>
        </div>
        <!-- Google Filters -->
        <div class="filterBorder">
            <b>Filters</b><br><br>
            <div [className]="gads_data_error ? 'label-input-block largeErrorElement' : 'label-input-block'">
                YouTube <mat-slide-toggle name="gadsDataYouTube" [(ngModel)]="data_youtube" formControlName="gadsDataYouTube" id="gadsDataYouTube" (ngModelChange)="onFilterToggleChanged()"></mat-slide-toggle>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                Website Display <mat-slide-toggle name="gadsDataDisplay" [(ngModel)]="data_display" formControlName="gadsDataDisplay" id="gadsDataDisplay" (ngModelChange)="onFilterToggleChanged()"></mat-slide-toggle>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                Mobile <mat-slide-toggle name="gadsDataMobile" [(ngModel)]="data_mobile" formControlName="gadsDataMobile" id="gadsDataMobile" (ngModelChange)="onFilterToggleChanged()"></mat-slide-toggle>
                <span class="error_text" *ngIf=gads_data_error>You must select at least one data type to retrieve</span>
            </div><br><br>
            <div class="label-input-block ">
                <label for="gadsField">Metric & Dimensions</label><br>
                <select name="gadsField" formControlName="gadsField" class="inputElement" id="gadsField">
                    <option *ngFor="let item of relevantMetricArray" [value]=item[0]>{{ item[1] }}</option>
                </select>
            </div>
            <div class="label-input-block">
                <label for="gadsOperator">Operator</label><br>
                <select name="gadsOperator" formControlName="gadsOperator" class="inputElement" id="gadsOperator">
                    <option *ngFor="let item of gadsOperatorsArray" [value]=item[0]>{{ item[1] }}</option>
                </select>
            </div>
            <div class="label-input-block">
                <label for="gadsValue">Value <span class="error_text" *ngIf=gads_error>{{gads_error_msg}}</span></label><br>
                <input type="text" [className]="gads_error ? 'errorElement' : 'inputElement'"
                    formControlName="gadsValue" name="gadsValue">
            </div>
            <div class="label-input-block">
                <button type="button" id="gadsAddToFilters" class="focusButton" (click)="gadsAddFilter()"
                    [disabled]=!conditionEnabled>+ Add</button>
            </div>
            <div class="label-input-block">
                <button type="button" id="gadsAddAnd" class="focusButton" (click)="gadsAddOrAnd('AND')"
                    [disabled]=!orAndEnabled>AND</button>
            </div>
            <div class="label-input-block">
                <button type="button" id="gadsAddOr" class="focusButton" (click)="gadsAddOrAnd('OR')"
                    [disabled]=!orAndEnabled>OR</button>
            </div>
            <div>
                <div class="label-input-block">
                    &nbsp; &nbsp; &nbsp;<mat-icon class="bigicon">subdirectory_arrow_right</mat-icon>
                    &nbsp;<input [className]="gads_filter_error ? 'errorElement extrawide' : 'inputElement extrawide'"
                        type="text" [(ngModel)]=finalGadsFilter formControlName="gadsFinalFilters" name="gadsFinalFilters"
                        value="{{finalGadsFilter}}" [readonly]=gads_filter_lock>
                    <br><span class="error_text" *ngIf=gads_filter_error>Errors in format. Do not end with OR or AND</span>
                </div>
                <div class="label-input-block">
                    <button type="button" id="unlockFilter" class="bigicon" (click)="unlockFilter()" matTooltip="Unlock/lock filter for free text">
                        <mat-icon class="red_icon" *ngIf="gads_filter_lock">lock</mat-icon>
                        <mat-icon class="green_icon" *ngIf="!gads_filter_lock">lock_open</mat-icon>
                    </button>
                    <button type="button" id="clearGadsFilter" class="deleteButton" (click)="clearFilter()" matTooltip="Clear current GAds filters">
                        <mat-icon>delete_forever</mat-icon>
                    </button>
                </div>
            </div>
        </div>
        <br>
        <br>
        <!-- Form End -->
        <br>
        <div class="label-input-block formSubmits">
            <div class="float-left">
            <div class="label-input-block">
                <button type="button" class="secondaryButton" (click)="previewPlacements()"
                    value="Preview">Preview Results</button>
            </div>
            <div class="label-input-block">
                <button type="button" [className]="exclude_count == 0 ? 'disabledButton' : 'secondaryButton'"
                    (click)="runManualExcludeForm()" value="Preview">Manually Exclude ({{ exclude_count }})</button>
            </div>
        </div>
        <div class="label-input-block" [hidden]="email_alerts_hidden">
        <label for="taskOutputDrowpDown">Exclude or Notify?</label></div>
        <div class="label-input-block" [hidden]="email_alerts_hidden">
                <select name="taskOutputDrowpDown" class="smallInputElement" formControlName="taskOutputDrowpDown" id="taskOutputDrowpDown" [(ngModel)]="selectedTaskOutput">
                  <option *ngFor="let item of taskOutputArray" [value]="item[0]" [selected]="item[0] === defaultTaskOutput">{{ item[1] }}</option>
                </select>
          </div>
          <div class="label-input-block">
            <button type="button" class="saveButton" (click)="save_task()">{{save_button}}</button>
          </div>
        </div>
    </form>
</div>
<p>
<!---->
<div *ngIf="table_result.length > 0" >
    <div class="pagination-left">
        <span class="error_text" *ngIf=memory_error><mat-icon>warning</mat-icon> Your report is only partial due to memory of your instance being reached</span>
        </div>
    <div class="pagination">
    <form [formGroup]="paginationForm">
        <div class="label-input-block">	<a (click)="downloadCSV()"><mat-icon>save_alt</mat-icon> Download CSV</a></div>
        <div class="label-input-block">
            <span *ngIf="pagination_start+pagination_rpp <= table_result.length">
                {{pagination_start+1}} to {{pagination_start+pagination_rpp}} of {{table_result.length}}
            </span>
            <span *ngIf="pagination_start+pagination_rpp > table_result.length  && table_result.length > 0">
                {{pagination_start+1}} to {{table_result.length}} of {{table_result.length}}
            </span>
        </div>
        <div class="label-input-block">
            <button type="button" class="pageButton" (click)="pagination_prev()"><<</button>
        </div>
        <div class="label-input-block">
            <select name="paginationValue" formControlName="paginationValue" (change)="paginationChange()"
                class="pageElement" id="paginationValue">
                <option *ngFor="let item of pagination_values" [value]=item[0]>{{ item[0] }}</option>
            </select>
        </div>
        <div class="label-input-block">
            <button type="button" class="pageButton" (click)="pagination_next()">>></button>
        </div>
    </form>
</div>
</div>
<span *ngIf="table_result.length > 0">
From:&nbsp;{{this.date_from}} &nbsp;&nbsp;&nbsp;To:&nbsp;{{this.date_to}}
</span>
<br><br>
<input *ngIf="table_result.length > 0" type="checkbox" [(ngModel)]="isCheckAll" (ngModelChange)="toggleCheckAll(isCheckAll)">
<span *ngIf="table_result.length > 0">Un/check all</span>
<table *ngIf="table_result.length > 0" class="styled-table newtask-width">
    <thead>
        <tr>
            <th class="hrlink"><a (click)="sort_table('default')">Exclude</a></th>
            <th class="hrlink"><a (click)="sort_table('excluded_already')">Status</a></th>
            <th class="hrlink"><a (click)="sort_table('allowlist')">Allowlist</a></th>
            <ng-container *ngFor="let header of column_headers">
                <th *ngIf="!hidden_columns.includes(header)  " class="hrlink"><a (click)="sort_table('{{header}}')">{{header}}</a></th>
            </ng-container>
        </tr>
    </thead>
    <tbody>
        <tr *ngFor="let data of table_result | slice:pagination_start:pagination_start+pagination_rpp; let i =index"
        [className]="row_class(data.excluded_already, data.exclude_from_account, data.allowlist)">
            <td>
                <input [value]="data.placement" type="checkbox"
                    (change)="!data.excluded_already && !data.allowlist ? excludeCheckChange(data.placement, data.exclude_from_account) : null"
                    [checked]="data.exclude_from_account && !data.excluded_already && !data.allowlist"
                    [disabled]="data.excluded_already || data.allowlist"/></td>
            <td *ngIf="data.excluded_already"><mat-icon matTooltip="Excluded">block</mat-icon></td>
            <td *ngIf="!data.excluded_already"><mat-icon matTooltip="Active" class="green_icon">check_circle</mat-icon></td>
            <td><span *ngIf="!data.allowlist"><a class="grey_icon" (click)="addToAllowlist(data.placement_type, data.placement)"
                target="_self" matTooltip="Add placement to allowlist so it is never excluded"><mat-icon>add_circle_outline</mat-icon></a></span>

                <span *ngIf="data.allowlist"><a (click)="removeFromAllowlist(data.placement)"
                    target="_self" matTooltip="Remove placement from allowlist so it can be excluded"><mat-icon class="gold_icon">stars</mat-icon></a></span>
                </td>

            <ng-container *ngFor="let item of data | keyvalue: unsorted; let i=index">
                <td *ngIf="!hidden_columns.includes(column_headers[i])">
                    <span *ngIf="item.value == 'YOUTUBE_CHANNEL'"><mat-icon matTooltip="YouTube Channel">video_library</mat-icon></span>
                    <span *ngIf="item.value == 'YOUTUBE_VIDEO'"><mat-icon matTooltip="YouTube Channel">video_library</mat-icon></span>
                    <span *ngIf="item.value == 'WEBSITE'"><mat-icon matTooltip="Website">computers</mat-icon></span>
                    <span *ngIf="item.value == 'MOBILE_APPLICATION'"><mat-icon matTooltip="Mobile App Category">mobile_friendly</mat-icon></span>
                    <span *ngIf="item.value == 'MOBILE_APP_CATEGORY'"><mat-icon matTooltip="Mobile App Category">mobile_friendly</mat-icon></span>
                    <span *ngIf="column_headers[i] == 'name'"><a href="https://{{data['url']}}" target="_blank">{{item.value}}</a></span>
                    <span *ngIf="!['placement_type', 'name'].includes(column_headers[i])">{{item.value}}</span>
                </td>
            </ng-container>
        </tr>
    </tbody>
</table>
<div *ngIf="no_data" class="empty-table">No data matches your Google Ads filters!</div>
<app-loading [showSpinner]=loading></app-loading>
